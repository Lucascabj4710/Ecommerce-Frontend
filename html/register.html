<!DOCTYPE html>
<html lang="es">
<head>
  <script src="../js/checkJwt.js" defer></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Registrarse - Paradiise</title>

  <!-- Requisitos del header -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="../css/normalize.css"/>
  <link rel="stylesheet" href="../css/style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      --bg:#fef0f8; --card:#ffffff; --text:#3a2c35; --muted:#9d758e;
      --brand:#ec4899; --brand-2:#db2777; --ring:rgba(236,72,153,.18);
      --shadow:0 10px 30px rgba(236,72,153,.12); --radius:16px;
      --ok:#22c55e; --err:#ef4444;
    }
    body{
      margin:0; min-height:100dvh; color:var(--text);
      background:
        radial-gradient(1200px 500px at 10% -10%, #ffe3f1 0%, rgba(255,255,255,0) 60%),
        radial-gradient(900px 500px at 120% 110%, #ffd8ec 0%, rgba(255,255,255,0) 55%),
        #fff;
      display:flex; flex-direction:column;
    }
    .page-wrap{ width:100%; max-width:980px; margin: clamp(24px, 6vw, 64px) auto 32px; padding: 0 20px; }
    .card-form{ background:var(--card); border-radius:var(--radius); box-shadow: var(--shadow); border:1px solid #ffe4f1; overflow:hidden; }
    .card-head{ padding: 20px 22px 10px; display:flex; align-items:center; gap:12px; }
    .badge{ width:44px; height:44px; border-radius:12px; color:#fff; font-size:1.3rem;
      background:linear-gradient(135deg, var(--brand), var(--brand-2));
      display:grid; place-items:center; box-shadow:0 6px 16px rgba(236,72,153,.35);
    }
    .titles{ display:flex; flex-direction:column; }
    .titles h1{ margin:0; font-size:clamp(1.25rem,3vw,1.6rem); }
    .titles p{ margin:2px 0 0; color:var(--muted); }
    .card-body{ padding: 8px 22px 22px; display:grid; gap:14px; }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    @media (max-width:720px){ .grid-2{ grid-template-columns:1fr; } }
    .field{ display:grid; gap:8px; }
    .input-wrap{ display:flex; align-items:center; gap:10px;
      border:1px solid #f9c2df; border-radius:12px; padding:10px 12px; background:#fff;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    .input-wrap:focus-within{ border-color:var(--brand); box-shadow:0 0 0 5px var(--ring); }
    .input-wrap i{ color:#b06b8b; font-size:1.05rem; }
    .input-wrap input{ border:0; outline:0; width:100%; font-size:1rem; color:var(--text); background:transparent; }
    .help{ color:var(--muted); font-size:.9rem; display:flex; justify-content:space-between; }
    .error-msg{ color:var(--err); font-size:.9rem; display:none; }
    .actions{ display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; margin-top:8px; }
    .btn{ appearance:none; border:0; cursor:pointer; padding:10px 16px; border-radius:12px; font-weight:800;
      color:#fff; background: var(--brand);
      transition: transform .15s ease, filter .15s ease, box-shadow .15s ease;
      box-shadow: 0 10px 20px rgba(236,72,153,.22);
    }
    .btn:hover{ filter:brightness(.96); transform: translateY(-1px); }
    .btn:disabled{ opacity:.65; cursor:not-allowed; transform:none; box-shadow:none; }
    .btn-ghost{ background:#fff; color:var(--text); border:1px solid #f2cfe1; box-shadow:none; }
    .btn-ghost:hover{ background:#fff9fc; }
    .spinner{ width:18px; height:18px; border-radius:50%; border:3px solid rgba(255,255,255,.55);
      border-top-color:#fff; animation: spin .8s linear infinite; display:inline-block; vertical-align:-3px; margin-right:8px;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }
  </style>
</head>
<body>

  <!-- HEADER (idéntico al index) -->
  <header class="hero">
    <nav id="navbar" class="navegacion-principal contenedor">
      <ul class="menu">
        <li><a href="../index.html">Inicio</a></li>

        <li class="submenu">
          <a href="getProducts.html">Productos <i class="fa-solid fa-caret-down"></i></a>
          <ul class="submenu-items">
            <li class="submenu-has-children">
              <a href="getProducts.html?q=anillo">Anillos <i class="fa-solid fa-chevron-right"></i></a>
              <ul class="subsubmenu-items">
                <li><a href="getProducts.html?q=anillo&material=plata925">Plata 925</a></li>
                <li><a href="getProducts.html?q=anillo&material=acero-quirurgico">Acero quirúrgico</a></li>
                <li><a href="getProducts.html?q=anillo&material=acero-blanco">Acero blanco</a></li>
                <li><a href="getProducts.html?q=anillo&material=adero-dorado">Adero dorado</a></li>
              </ul>
            </li>
            <li class="submenu-has-children">
              <a href="getProducts.html?q=pulsera">Pulseras <i class="fa-solid fa-chevron-right"></i></a>
              <ul class="subsubmenu-items">
                <li><a href="getProducts.html?q=pulsera&material=plata925">Plata 925</a></li>
                <li><a href="getProducts.html?q=pulsera&material=acero-quirurgico">Acero quirúrgico</a></li>
                <li><a href="getProducts.html?q=pulsera&material=acero-blanco">Acero blanco</a></li>
                <li><a href="getProducts.html?q=pulsera&material=adero-dorado">Adero dorado</a></li>
              </ul>
            </li>
            <li class="submenu-has-children">
              <a href="getProducts.html?q=collar">Collares <i class="fa-solid fa-chevron-right"></i></a>
              <ul class="subsubmenu-items">
                <li><a href="getProducts.html?q=collar&material=plata925">Plata 925</a></li>
                <li><a href="getProducts.html?q=collar&material=acero-quirurgico">Acero quirúrgico</a></li>
                <li><a href="getProducts.html?q=collar&material=acero-blanco">Acero blanco</a></li>
                <li><a href="getProducts.html?q=collar&material=adero-dorado">Adero dorado</a></li>
              </ul>
            </li>
            <li><a href="getProducts.html?q=relojes">Relojes</a></li>
            <li><a href="getProducts.html?q=carteras">Carteras</a></li>
          </ul>
        </li>

        <li><a href="contacto.html">Contacto</a></li>

        <li class="submenu">
          <a href="#">Cuenta <i class="fa-solid fa-caret-down"></i></a>
          <ul class="submenu-items">
            <li><a href="login.html">Iniciar sesión</a></li>
            <li><a href="register.html" class="active">Registrarme</a></li>
            <li><a href="admin.html">Panel de control ADMIN</a></li>
            <li><a href="dashboard.html">Mi perfil</a></li>
            <li><a href="logout.php">Cerrar sesión</a></li>
          </ul>
        </li>

        <li class="carrito">
          <a href="carrito.html" aria-label="Ver carrito">
            <img src="../imagenes/carrito2.png" alt="Carrito" width="32">
          </a>
        </li>
      </ul>
    </nav>
  </header>
  <!-- FIN HEADER -->

  <div class="page-wrap">
    <form class="card-form" id="clientForm" novalidate>
      <div class="card-head">
        <div class="badge"><i class="fa-solid fa-user-plus"></i></div>
        <div class="titles">
          <h1>Registrarse</h1>
          <p>Cargá los datos del cliente. Revisá que el email y el DNI sean correctos.</p>
        </div>
      </div>

      <div class="card-body">
        <div class="grid-2">
          <div class="field">
            <label for="name">Nombre</label>
            <div class="input-wrap">
              <i class="fa-regular fa-id-badge"></i>
              <input type="text" id="name" maxlength="60" required placeholder="Ej.: Juan">
            </div>
            <small class="error-msg" id="err-name">Ingresá un nombre válido.</small>
          </div>
          <div class="field">
            <label for="lastname">Apellido</label>
            <div class="input-wrap">
              <i class="fa-regular fa-id-badge"></i>
              <input type="text" id="lastname" maxlength="60" required placeholder="Ej.: Pérez">
            </div>
            <small class="error-msg" id="err-lastname">Ingresá un apellido válido.</small>
          </div>
        </div>

        <div class="grid-2">
          <div class="field">
            <label for="phoneNumber">Teléfono</label>
            <div class="input-wrap">
              <i class="fa-solid fa-phone"></i>
              <input type="text" id="phoneNumber" maxlength="20" required placeholder="Ej.: 11 5555 1234">
            </div>
            <small class="error-msg" id="err-phone">Ingresá un teléfono válido.</small>
          </div>
          <div class="field">
            <label for="dni">DNI</label>
            <div class="input-wrap">
              <i class="fa-regular fa-address-card"></i>
              <input type="text" id="dni" maxlength="12" required placeholder="Ej.: 12.345.678">
            </div>
            <small class="error-msg" id="err-dni">Ingresá un DNI válido.</small>
          </div>
        </div>

        <div class="field">
          <label for="email">Email</label>
          <div class="input-wrap">
            <i class="fa-regular fa-envelope"></i>
            <input type="email" id="email" maxlength="120" required placeholder="ejemplo@correo.com">
          </div>
          <small class="error-msg" id="err-email">Ingresá un email válido.</small>
        </div>

        <div class="grid-2">
          <div class="field">
            <label for="username">Usuario</label>
            <div class="input-wrap">
              <i class="fa-regular fa-user"></i>
              <input type="text" id="username" maxlength="40" required placeholder="Ej.: juanperez">
            </div>
            <small class="error-msg" id="err-username">El usuario debe tener al menos 4 caracteres.</small>
          </div>
          <div class="field">
            <label for="password">Contraseña</label>
            <div class="input-wrap">
              <i class="fa-solid fa-lock"></i>
              <input type="password" id="password" minlength="6" maxlength="64" required placeholder="Mín. 6 caracteres">
            </div>
            <small class="error-msg" id="err-password">La contraseña debe tener al menos 6 caracteres.</small>
          </div>
        </div>

        <div class="actions">
          <a href="../index.html" class="btn btn-ghost">← Volver al inicio</a>
          <button id="submitBtn" class="btn" type="submit">Registrarse</button>
        </div>
      </div>
    </form>
  </div>

  <!-- JS menú responsive por click -->
  <script>
    (function () {
      const mq = window.matchMedia('(max-width: 900px)');
      document.addEventListener('click', (e) => {
        const trigger = e.target.closest('.submenu > a'); if (!trigger) return;
        if (mq.matches) {
          e.preventDefault();
          const li = trigger.parentElement;
          document.querySelectorAll('.submenu.open').forEach(x => { if (x !== li) x.classList.remove('open'); });
          li.classList.toggle('open');
        }
      });
      document.addEventListener('click', (e) => {
        const trigger = e.target.closest('.submenu-has-children > a'); if (!trigger) return;
        if (mq.matches) {
          e.preventDefault();
          const li = trigger.parentElement;
          li.classList.toggle('open');
          const panel = li.querySelector('.subsubmenu-items');
          if (panel) panel.style.display = (panel.style.display === 'block' ? 'none' : 'block');
        }
      });
    })();
  </script>

  <!-- Lógica de registro -->
  <script>
    const $ = (q)=>document.querySelector(q);
    const form = $('#clientForm');
    const btn = $('#submitBtn');
    const validators = {
      name: v => v.trim().length >= 2,
      lastname: v => v.trim().length >= 2,
      phoneNumber: v => /^[0-9+()\s.-]{6,}$/.test(v.trim()),
      dni: v => /^[0-9.\-]{6,12}$/.test(v.trim()),
      email: v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v.trim()),
      username: v => v.trim().length >= 4,
      password: v => v.length >= 6
    };
    const fields = ['name','lastname','phoneNumber','dni','email','username','password'];
    function showError(id, ok){
      const el = document.getElementById('err-'+id);
      if(!el) return;
      el.style.display = ok ? 'none' : 'block';
    }
    function validateAll(){
      let allOk = true;
      for(const id of fields){
        const val = document.getElementById(id).value;
        const ok = validators[id](val);
        showError(id, ok);
        allOk = allOk && ok;
      }
      btn.disabled = !allOk || sending;
      return allOk;
    }
    fields.forEach(id=>{
      const input = document.getElementById(id);
      input.addEventListener('input', validateAll);
      input.addEventListener('blur', validateAll);
    });
    let sending = false;
    async function createClient(payload){
      const res = await fetch("http://localhost:8080/client/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      return res;
    }
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!validateAll()) return;
      const clientData = {
        name: $('#name').value.trim(),
        lastname: $('#lastname').value.trim(),
        phoneNumber: $('#phoneNumber').value.trim(),
        dni: $('#dni').value.trim(),
        email: $('#email').value.trim(),
        userEntityDto: {
          username: $('#username').value.trim(),
          password: $('#password').value
        }
      };
      try{
        sending = true; btn.disabled = true;
        const prev = btn.innerHTML; btn.innerHTML = `<span class="spinner"></span>Registrando...`;
        const response = await createClient(clientData);
        if(response.ok){
          let text = ''; try{ text = await response.text(); }catch{}
          await Swal.fire({ icon:'success', title:'¡Registro exitoso!', text: text || 'Operación realizada con éxito', confirmButtonColor:'#ec4899' });
          form.reset();
        }else{
          let errText = ''; try{ errText = await response.text(); }catch{}
          await Swal.fire({ icon:'error', title:'No se pudo registrar', text: errText || `HTTP ${response.status}`, confirmButtonColor:'#ec4899' });
        }
      }catch(err){
        await Swal.fire({ icon:'error', title:'Error de conexión', text: err?.message || 'Reintentalo en unos segundos.', confirmButtonColor:'#ec4899' });
      }finally{
        sending = false; btn.innerHTML = 'Registrarse'; validateAll();
      }
    });
    validateAll();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
</body>
</html>
