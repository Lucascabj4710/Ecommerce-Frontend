<!DOCTYPE html>
<html lang="es">
<head>
  <script src="../js/checkJwt.js" defer></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Actualizar Contraseña - Paradiise</title>

  <!-- Estilos base del sitio -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../css/normalize.css" />
  <link rel="stylesheet" href="../css/style.css" />

  <style>
    :root{
      --bg1:#ffeaf4; --bg2:#fff6fb; --card:#fff; --text:#3a1c2a; --muted:#8c607a;
      --brand1:#ec4899; --brand2:#f472b6; --ring: rgba(236,72,153,.18);
      --border: 1px solid rgba(236,72,153,.22);
      --shadow: 0 14px 36px rgba(236,72,153,.18);
      --radius: 16px;
      --ok:#16a34a; --err:#dc2626;
    }
    html, body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background: linear-gradient(165deg, var(--bg1) 0%, var(--bg2) 100%);
    }

    main{ padding: 28px 16px 60px; }
    .wrap{ max-width: 520px; margin: 0 auto; }

    .back-btn{
      display:inline-flex; align-items:center; gap:.5rem;
      padding:10px 14px; border-radius:12px; text-decoration:none; font-weight:700;
      background:#fff; color:var(--brand1); border:var(--border);
      box-shadow: 0 6px 18px rgba(236,72,153,.12); margin: 14px 0;
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease, color .18s ease;
    }
    .back-btn:hover{ transform: translateY(-2px); background: linear-gradient(90deg, var(--brand1), var(--brand2)); color:#fff; box-shadow: var(--shadow); }

    .card-form{
      background: var(--card);
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 28px;
    }
    h1{
      margin: 0 0 8px; text-align:center; font-weight: 800;
      font-size: clamp(1.4rem, 1.1rem + 1.2vw, 2rem);
      background: linear-gradient(90deg, var(--brand1), var(--brand2));
      -webkit-background-clip: text; background-clip: text; color: transparent;
      text-shadow: 0 12px 40px rgba(236,72,153,.28);
    }
    .subtitle{ text-align:center; margin: 0 0 22px; color: var(--muted); }

    .field{ margin-bottom: 14px; }
    .field label{ display:block; font-weight:700; margin-bottom:6px; color:#4b2b39; }
    .control{ position: relative; }
    input[type="password"]{
      width:100%; padding: 12px 42px 12px 14px; border-radius: 12px;
      border: 1.6px solid rgba(236,72,153,.25); background:#fff; color:var(--text); font-size:1rem;
      transition: border-color .18s ease, box-shadow .18s ease;
    }
    input[type="password"]:focus{ outline:none; border-color:var(--brand1); box-shadow:0 0 0 4px var(--ring); }
    .toggle{
      position:absolute; top:50%; right:12px; transform:translateY(-50%);
      width:34px; height:34px; border-radius:50%; display:grid; place-items:center;
      cursor:pointer; color:#7a5166;
    }
    .meter{ height:8px; border-radius:999px; background:#f3d7e7; overflow:hidden; margin-top:6px; }
    .meter > span{ display:block; height:100%; width:0%; background:linear-gradient(90deg,#f87171,#f59e0b,#10b981); transition: width .25s ease; }

    .actions{ margin-top: 12px; display:flex; gap: 10px; }
    .btn-primary{
      flex:1; padding: 14px 16px; border:none; border-radius:12px; cursor:pointer; font-weight:800;
      background: linear-gradient(90deg, var(--brand1), var(--brand2)); color:#fff;
      box-shadow: 0 10px 24px rgba(236,72,153,.25);
      transition: transform .16s ease, box-shadow .18s ease, filter .12s ease, opacity .12s ease;
    }
    .btn-primary:hover{ transform: translateY(-2px); box-shadow: 0 14px 32px rgba(236,72,153,.35); filter: brightness(1.02); }
    .btn-primary:disabled{ opacity:.65; cursor:not-allowed; }

    .msg{ text-align:center; font-weight:700; margin-top:10px; }
    .msg.ok{ color: var(--ok); } .msg.err{ color: var(--err); }
  </style>
</head>
<body>

  <!-- HEADER REPLICADO DEL INDEX -->
  <header>
    <div class="hero">
      <nav id="navbar" class="navegacion-principal contenedor">
        <ul class="menu">
          <li><a href="index.html">Inicio</a></li>

          <li class="submenu">
            <a href="getProducts.html">Productos <i class="fa-solid fa-caret-down"></i></a>
            <ul class="submenu-items">
              <li class="submenu-has-children">
                <a href="getProducts.html?q=anillo">Anillos <i class="fa-solid fa-chevron-right"></i></a>
                <ul class="subsubmenu-items">
                  <li><a href="getProducts.html?q=anillo&material=plata925">Plata 925</a></li>
                  <li><a href="getProducts.html?q=anillo&material=acero-quirurgico">Acero quirúrgico</a></li>
                  <li><a href="getProducts.html?q=anillo&material=acero-blanco">Acero blanco</a></li>
                  <li><a href="getProducts.html?q=anillo&material=adero-dorado">Adero dorado</a></li>
                </ul>
              </li>

              <li class="submenu-has-children">
                <a href="getProducts.html?q=pulsera">Pulseras <i class="fa-solid fa-chevron-right"></i></a>
                <ul class="subsubmenu-items">
                  <li><a href="getProducts.html?q=pulsera&material=plata925">Plata 925</a></li>
                  <li><a href="getProducts.html?q=pulsera&material=acero-quirurgico">Acero quirúrgico</a></li>
                  <li><a href="getProducts.html?q=pulsera&material=acero-blanco">Acero blanco</a></li>
                  <li><a href="getProducts.html?q=pulsera&material=adero-dorado">Adero dorado</a></li>
                </ul>
              </li>

              <li class="submenu-has-children">
                <a href="getProducts.html?q=collar">Collares <i class="fa-solid fa-chevron-right"></i></a>
                <ul class="subsubmenu-items">
                  <li><a href="getProducts.html?q=collar&material=plata925">Plata 925</a></li>
                  <li><a href="getProducts.html?q=collar&material=acero-quirurgico">Acero quirúrgico</a></li>
                  <li><a href="getProducts.html?q=collar&material=acero-blanco">Acero blanco</a></li>
                  <li><a href="getProducts.html?q=collar&material=adero-dorado">Adero dorado</a></li>
                </ul>
              </li>

              <li><a href="getProducts.html?q=relojes">Relojes</a></li>
              <li><a href="getProducts.html?q=carteras">Carteras</a></li>
            </ul>
          </li>

          <li><a href="contacto.html">Contacto</a></li>

          <li class="submenu">
            <a href="#">Cuenta <i class="fa-solid fa-caret-down"></i></a>
            <ul class="submenu-items">
              <li><a href="login.html">Iniciar sesión</a></li>
              <li><a href="register.html">Registrarme</a></li>
              <li><a href="admin.html">Panel de control ADMIN</a></li>
              <li><a href="dashboard.html">Mi perfil</a></li>
              <li><a href="logout.php">Cerrar sesión</a></li>
            </ul>
          </li>

          <li class="carrito">
            <a href="carrito.html" aria-label="Carrito">
              <img src="../imagenes/carrito2.png" alt="Carrito" width="32" height="32" />
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </header>
  <!-- FIN HEADER -->

  <main>
    <div class="wrap">
      <a class="back-btn" href="dashboard.html">← Volver a Mi Perfil</a>

      <div class="card-form">
        <h1>Actualizar contraseña</h1>
        <p class="subtitle">Elegí una contraseña segura y confirmala</p>

        <form id="pwdForm" novalidate>
          <div class="field">
            <label for="password">Nueva contraseña *</label>
            <div class="control">
              <input type="password" id="password" autocomplete="new-password" required />
              <button type="button" class="toggle" aria-label="Mostrar/ocultar" data-target="password">
                <i class="fa-regular fa-eye"></i>
              </button>
            </div>
            <div class="meter" aria-hidden="true"><span id="strengthBar"></span></div>
          </div>

          <div class="field">
            <label for="confirm">Confirmar contraseña *</label>
            <div class="control">
              <input type="password" id="confirm" autocomplete="new-password" required />
              <button type="button" class="toggle" aria-label="Mostrar/ocultar" data-target="confirm">
                <i class="fa-regular fa-eye"></i>
              </button>
            </div>
          </div>

          <div class="actions">
            <button id="submitBtn" class="btn-primary" type="submit">Guardar</button>
          </div>

          <div id="msg" class="msg" role="alert" aria-live="polite"></div>
        </form>
      </div>
    </div>
  </main>

  <script>
    (function(){
      const API = "http://localhost:8080";
      const form = document.getElementById("pwdForm");
      const msg  = document.getElementById("msg");
      const submitBtn = document.getElementById("submitBtn");
      const pwd = document.getElementById("password");
      const conf = document.getElementById("confirm");
      const bar = document.getElementById("strengthBar");

      const token = localStorage.getItem("jwtToken");
      if(!token){ window.location.replace("login.html"); return; }

      function parseJwt (t) {
        try { return JSON.parse(atob(t.split('.')[1])); }
        catch(e){ return null; }
      }
      const payload = parseJwt(token);

      document.querySelectorAll(".toggle").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.dataset.target;
          const input = document.getElementById(id);
          const isPwd = input.type === "password";
          input.type = isPwd ? "text" : "password";
          btn.innerHTML = isPwd ? '<i class="fa-regular fa-eye-slash"></i>' : '<i class="fa-regular fa-eye"></i>';
        });
      });

      function strength(s){
        let score = 0;
        if(s.length >= 8) score++;
        if(/[A-Z]/.test(s)) score++;
        if(/[a-z]/.test(s)) score++;
        if(/\d/.test(s)) score++;
        if(/[^A-Za-z0-9]/.test(s)) score++;
        return Math.min(score, 5);
      }
      pwd.addEventListener("input", ()=>{
        const sc = strength(pwd.value);
        bar.style.width = (sc*20) + "%";
      });

      function show(type, text){
        msg.className = "msg " + (type === "ok" ? "ok" : "err");
        msg.textContent = text;
      }

      form.addEventListener("submit", async (e)=>{
        e.preventDefault();
        msg.textContent = "";
        submitBtn.disabled = true;

        const p = pwd.value.trim();
        const c = conf.value.trim();

        if(!p || !c){
          show("err","Completá ambos campos.");
          submitBtn.disabled = false;
          return;
        }
        if(p !== c){
          show("err","Las contraseñas no coinciden.");
          submitBtn.disabled = false;
          return;
        }
        if(p.length < 8){
          show("err","La contraseña debe tener al menos 8 caracteres.");
          submitBtn.disabled = false;
          return;
        }

        try{
          const res = await fetch(API + "/user/update", {
            method: "PUT",
            headers: {
              "Content-Type":"application/json",
              "Authorization": "Bearer " + token
            },
            body: JSON.stringify({ 
              username: payload?.sub || "",  
              password: p 
            })
          });
          const text = await res.text();

          if(res.ok){
            show("ok", text || "Contraseña actualizada con éxito.");
            form.reset();
            bar.style.width = "0%";
          }else{
            show("err", text || "No se pudo actualizar la contraseña.");
          }
        }catch(err){
          console.error(err);
          show("err","Error de conexión con el servidor.");
        }finally{
          submitBtn.disabled = false;
        }
      });
    })();
  </script>

  <!-- JS opcionales -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
</body>
</html>
