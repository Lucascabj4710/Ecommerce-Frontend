<!DOCTYPE html>
<html lang="es">
<head>
  <script src="../js/checkJwt.js" defer></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Actualizar Producto - Paradiise</title>

  <!-- Bootstrap, FontAwesome y tus estilos globales -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../css/normalize.css" />
  <link rel="stylesheet" href="../css/style.css" />

  <style>
    :root{
      --bg1:#ffeaf4; --bg2:#fff6fb; --card:#fff; --text:#3a1c2a; --muted:#8c607a;
      --brand1:#ec4899; --brand2:#f472b6; --ring: rgba(236,72,153,.16);
      --border: 1px solid rgba(236,72,153,.18);
      --shadow-sm: 0 6px 18px rgba(236,72,153,.12);
      --shadow-lg: 0 14px 36px rgba(236,72,153,.18);
      --radius: 16px;
    }
    html, body { height:100% }
    body{
      margin:0; color:var(--text);
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background: linear-gradient(165deg, var(--bg1) 0%, var(--bg2) 100%);
    }

    main{ padding: 28px 16px 60px; }
    .wrap{ max-width: 860px; margin: 0 auto; }

    .back-btn{
      display:inline-flex; align-items:center; gap:.5rem;
      padding:10px 14px; border-radius:12px; text-decoration:none; font-weight:700;
      background:#fff; color:var(--brand1); border:var(--border);
      box-shadow: var(--shadow-sm); margin: 14px 0;
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease, color .18s ease;
    }
    .back-btn:hover{ transform: translateY(-2px); background: linear-gradient(90deg, var(--brand1), var(--brand2)); color:#fff; box-shadow: var(--shadow-lg); }

    .card-form{
      background: var(--card);
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      padding: 28px;
    }
    .card-form h1{
      margin: 0 0 8px; text-align:center; font-weight: 800;
      font-size: clamp(1.4rem, 1.1rem + 1.2vw, 2rem);
      background: linear-gradient(90deg, var(--brand1), var(--brand2));
      -webkit-background-clip: text; background-clip: text; color: transparent;
      text-shadow: 0 12px 40px rgba(236,72,153,.28);
    }
    .subtitle{ text-align:center; margin: 0 0 22px; color: var(--muted); }

    form{ display:grid; grid-template-columns: 1fr 1fr; gap: 18px; }
    @media (max-width:720px){ form{ grid-template-columns: 1fr; } }
    .field{ display:flex; flex-direction:column; }
    .field label{ font-weight:700; margin-bottom:6px; color:#4b2b39; }

    input[type="text"], input[type="number"], select, input[type="file"]{
      padding: 12px 14px; border-radius: 12px; border: 1.6px solid rgba(236,72,153,.25);
      background: #fff; color: var(--text); font-size: 1rem;
      transition: border-color .18s ease, box-shadow .18s ease, background .18s ease;
    }
    input:focus, select:focus, input[type="file"]:focus{
      outline:none; border-color: var(--brand1); box-shadow: 0 0 0 4px var(--ring); background: #fff;
    }

    #previewImage{
      grid-column: 1 / -1; max-width: 100%; display:none;
      border-radius: 12px; border: 1px dashed rgba(236,72,153,.35);
      padding: 8px; background: #fff9fc; box-shadow: 0 6px 18px rgba(236,72,153,.12);
    }

    .actions{ grid-column: 1 / -1; display:flex; justify-content:center; gap: 12px; }
    button{
      padding: 14px 20px; border: none; border-radius: 12px; cursor:pointer; font-weight:800; font-size: 1.05rem;
      background: linear-gradient(90deg, var(--brand1), var(--brand2)); color:#fff;
      box-shadow: 0 10px 24px rgba(236,72,153,.25);
      transition: transform .16s ease, box-shadow .18s ease, filter .12s ease, opacity .12s ease;
    }
    button:hover{ transform: translateY(-2px); box-shadow: 0 14px 32px rgba(236,72,153,.35); filter: brightness(1.02); }
    button:disabled{ opacity:.65; cursor: not-allowed; }

    #message{ grid-column: 1 / -1; text-align:center; font-weight:700; margin-top: 6px; }
    .success{ color:#16a34a; } .error{ color:#dc2626; }
  </style>
</head>
<body>


  <main>
    <div class="wrap">
      <a class="back-btn" href="admin.html">← Volver al Panel Admin</a>

      <div class="card-form" role="main" aria-label="Formulario para actualizar producto">
        <h1>Actualizar producto</h1>
        <p class="subtitle">Cambiá los datos y subí una nueva imagen si querés</p>

        <form id="updateForm" enctype="multipart/form-data" novalidate>
          <div class="field" style="grid-column:1 / -1;">
            <label for="name">Nombre del producto (clave de búsqueda) *</label>
            <input type="text" id="name" name="name" required placeholder="Nombre exacto del producto"/>
          </div>

          <div class="field">
            <label for="price">Precio *</label>
            <input type="number" id="price" name="price" step="0.01" min="0" required placeholder="Precio ARS"/>
          </div>

          <div class="field">
            <label for="stock">Stock *</label>
            <input type="number" id="stock" name="stock" min="0" required placeholder="Cantidad en stock"/>
          </div>

          <div class="field">
            <label for="color">Color</label>
            <input type="text" id="color" name="color" placeholder="Color"/>
          </div>

          <div class="field">
            <label for="material">Material</label>
            <input type="text" id="material" name="material" placeholder="Material"/>
          </div>

          <div class="field">
            <label for="waist">Talle</label>
            <input type="text" id="waist" name="waist" placeholder="Talle / Medida"/>
          </div>

          <div class="field">
            <label for="categoriaSelect">Categoría *</label>
            <select id="categoriaSelect" name="idCategory" required>
              <option value="" disabled selected>Seleccioná una categoría</option>
            </select>
          </div>

          <div class="field" style="grid-column:1 / -1;">
            <label for="file">Imagen (opcional)</label>
            <input type="file" id="file" name="file" accept="image/*">
            <small class="text-muted">Recomendado: 1200×900 — JPG/PNG/WEBP</small>
          </div>

          <img id="previewImage" alt="Vista previa de imagen" />

          <div class="actions">
            <button id="submitBtn" type="submit">Actualizar Producto</button>
          </div>
          <div id="message"></div>
        </form>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const API = "http://localhost:8080";
      const form = document.getElementById("updateForm");
      const msg  = document.getElementById("message");
      const fileInput = document.getElementById("file");
      const preview = document.getElementById("previewImage");
      const selectCat = document.getElementById("categoriaSelect");
      const submitBtn = document.getElementById("submitBtn");

      const token = localStorage.getItem("jwtToken");
      if(!token){
        // si no hay sesión, mandamos al login
        window.location.replace("login.html");
        return;
      }

      function showMessage(text, type="success"){
        msg.textContent = text;
        msg.className = type === "error" ? "error" : "success";
      }

      // Cargar categorías con autorización
      async function cargarCategorias(){
        try{
          const res = await fetch(API + "/category/get", {
            headers: { "Authorization": "Bearer " + token }
          });
          if(!res.ok) throw new Error("No se pudieron cargar categorías");
          const cats = await res.json();
          selectCat.innerHTML = '<option value="" disabled selected>Seleccioná una categoría</option>';
          (Array.isArray(cats)?cats:[]).forEach(c => {
            const opt = document.createElement("option");
            opt.value = c.idCategory;
            opt.textContent = c.name || ("Categoría " + c.idCategory);
            selectCat.appendChild(opt);
          });
        }catch(e){
          console.error(e);
          showMessage("Error cargando categorías", "error");
          selectCat.disabled = true;
        }
      }
      cargarCategorias();

      // Previsualización de imagen
      fileInput.addEventListener("change", () => {
        const f = fileInput.files[0];
        if(!f){ preview.src = ""; preview.style.display = "none"; return; }
        const reader = new FileReader();
        reader.onload = e => { preview.src = e.target.result; preview.style.display = "block"; }
        reader.readAsDataURL(f);
      });

      // Enviar actualización
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        msg.textContent = ""; msg.className = "";
        submitBtn.disabled = true;

        const name = document.getElementById("name").value.trim();
        const price = parseFloat(document.getElementById("price").value);
        const stock = parseInt(document.getElementById("stock").value, 10);
        const idCategory = selectCat.value;

        if(!name || isNaN(price) || price < 0 || isNaN(stock) || stock < 0 || !idCategory){
          showMessage("Completá correctamente los campos obligatorios.", "error");
          submitBtn.disabled = false;
          return;
        }

        // Armamos FormData (multipart). Enviamos campos simples + archivo si hay.
        const fd = new FormData();
        fd.append("name", name);
        fd.append("price", String(price));
        fd.append("stock", String(stock));
        fd.append("color", document.getElementById("color").value.trim());
        fd.append("material", document.getElementById("material").value.trim());
        fd.append("waist", document.getElementById("waist").value.trim());
        fd.append("idCategory", idCategory);
        if(fileInput.files.length > 0){ fd.append("file", fileInput.files[0]); }

        try{
          const res = await fetch(`${API}/products/update/${encodeURIComponent(name)}`, {
            method: "PUT",
            headers: { "Authorization": "Bearer " + token }, // IMPORTANTE si tu backend lo requiere
            body: fd
          });

          if(res.status === 401 || res.status === 403){
            window.location.replace("login.html");
            return;
          }

          if(!res.ok){
            const t = await res.text().catch(()=> "Error al actualizar");
            throw new Error(t);
          }

          showMessage("¡Producto actualizado con éxito!");
          form.reset();
          preview.src = ""; preview.style.display = "none";
        }catch(err){
          console.error(err);
          showMessage("Error: " + (err?.message || "No se pudo actualizar"), "error");
        }finally{
          submitBtn.disabled = false;
        }
      });
    });
  </script>

  <!-- JS opcionales -->
  <script src="../js/script.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
</body>
</html>
