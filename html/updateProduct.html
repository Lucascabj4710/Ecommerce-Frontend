<!DOCTYPE html>
<html lang="es">
<head>
  <script src="../js/checkJwt.js" defer></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Actualizar Producto - Paradiise</title>

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../css/normalize.css" />
  <link rel="stylesheet" href="../css/style.css" />

  <style>
    :root{
      --bg1:#ffeaf4; --bg2:#fff6fb; --card:#fff; --text:#3a1c2a; --muted:#8c607a;
      --brand1:#ec4899; --brand2:#f472b6; --ring: rgba(236,72,153,.16);
      --border: 1px solid rgba(236,72,153,.18);
      --shadow-sm: 0 6px 18px rgba(236,72,153,.12);
      --shadow-lg: 0 14px 36px rgba(236,72,153,.18);
      --radius: 16px;
    }
    body{
      margin:0; color:var(--text);
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background: linear-gradient(165deg, var(--bg1) 0%, var(--bg2) 100%);
    }

    main{ padding: 28px 16px 60px; }
    .wrap{ max-width: 860px; margin: 0 auto; }

    .back-btn{
      display:inline-flex; align-items:center; gap:.5rem;
      padding:10px 14px; border-radius:12px; text-decoration:none; font-weight:700;
      background:#fff; color:var(--brand1); border:var(--border);
      box-shadow: var(--shadow-sm); margin: 14px 0;
    }
    .back-btn:hover{ background: linear-gradient(90deg, var(--brand1), var(--brand2)); color:#fff; }

    .card-form{
      background: var(--card);
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      padding: 28px;
    }
    .card-form h1{
      margin: 0 0 8px; text-align:center; font-weight: 800;
      font-size: clamp(1.4rem, 1.1rem + 1.2vw, 2rem);
      background: linear-gradient(90deg, var(--brand1), var(--brand2));
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    .subtitle{ text-align:center; margin: 0 0 22px; color: var(--muted); }

    form{ display:grid; grid-template-columns: 1fr 1fr; gap: 18px; }
    @media (max-width:720px){ form{ grid-template-columns: 1fr; } }
    .field{ display:flex; flex-direction:column; }
    .field label{ font-weight:700; margin-bottom:6px; color:#4b2b39; }

    input[type="text"], input[type="number"], select, input[type="file"]{
      padding: 12px 14px; border-radius: 12px; border: 1.6px solid rgba(236,72,153,.25);
      background: #fff; color: var(--text); font-size: 1rem;
    }

    #previewImage{
      grid-column: 1 / -1; max-width: 100%; display:none;
      border-radius: 12px; border: 1px dashed rgba(236,72,153,.35);
      padding: 8px; background: #fff9fc;
    }

    .actions{ grid-column: 1 / -1; display:flex; justify-content:center; gap: 12px; }
    button{
      padding: 14px 20px; border: none; border-radius: 12px; cursor:pointer; font-weight:800;
      background: linear-gradient(90deg, var(--brand1), var(--brand2)); color:#fff;
    }

    #message{ grid-column: 1 / -1; text-align:center; font-weight:700; margin-top: 6px; }
    .success{ color:#16a34a; } .error{ color:#dc2626; }
  </style>
</head>
<body>

  <!-- HEADER IGUAL AL DEL INDEX -->
  <header class="hero">
    <nav id="navbar" class="navegacion-principal contenedor">
      <ul class="menu">
        <li><a href="../index.html">Inicio</a></li>

        <li class="submenu">
          <a href="getProducts.html">Productos <i class="fa-solid fa-caret-down"></i></a>
          <ul class="submenu-items">
            <li class="submenu-has-children">
              <a href="getProducts.html?q=anillo">Anillos <i class="fa-solid fa-chevron-right"></i></a>
              <ul class="subsubmenu-items">
                <li><a href="getProducts.html?q=anillo&material=plata925">Plata 925</a></li>
                <li><a href="getProducts.html?q=anillo&material=acero-quirurgico">Acero quirúrgico</a></li>
                <li><a href="getProducts.html?q=anillo&material=acero-blanco">Acero blanco</a></li>
                <li><a href="getProducts.html?q=anillo&material=adero-dorado">Adero dorado</a></li>
              </ul>
            </li>
            <li class="submenu-has-children">
              <a href="getProducts.html?q=pulsera">Pulseras <i class="fa-solid fa-chevron-right"></i></a>
              <ul class="subsubmenu-items">
                <li><a href="getProducts.html?q=pulsera&material=plata925">Plata 925</a></li>
                <li><a href="getProducts.html?q=pulsera&material=acero-quirurgico">Acero quirúrgico</a></li>
                <li><a href="getProducts.html?q=pulsera&material=acero-blanco">Acero blanco</a></li>
                <li><a href="getProducts.html?q=pulsera&material=adero-dorado">Adero dorado</a></li>
              </ul>
            </li>
            <li class="submenu-has-children">
              <a href="getProducts.html?q=collar">Collares <i class="fa-solid fa-chevron-right"></i></a>
              <ul class="subsubmenu-items">
                <li><a href="getProducts.html?q=collar&material=plata925">Plata 925</a></li>
                <li><a href="getProducts.html?q=collar&material=acero-quirurgico">Acero quirúrgico</a></li>
                <li><a href="getProducts.html?q=collar&material=acero-blanco">Acero blanco</a></li>
                <li><a href="getProducts.html?q=collar&material=adero-dorado">Adero dorado</a></li>
              </ul>
            </li>
            <li><a href="getProducts.html?q=relojes">Relojes</a></li>
            <li><a href="getProducts.html?q=carteras">Carteras</a></li>
          </ul>
        </li>

        <li><a href="contacto.html">Contacto</a></li>

        <li class="submenu">
          <a href="#">Cuenta <i class="fa-solid fa-caret-down"></i></a>
          <ul class="submenu-items">
            <li><a href="login.html">Iniciar sesión</a></li>
            <li><a href="register.html">Registrarme</a></li>
            <li><a href="admin.html">Panel de control ADMIN</a></li>
            <li><a href="dashboard.html">Mi perfil</a></li>
            <li><a href="logout.php">Cerrar sesión</a></li>
          </ul>
        </li>

        <li class="carrito">
          <a href="carrito.html" aria-label="Ver carrito">
            <img src="../imagenes/carrito2.png" alt="Carrito" width="32">
          </a>
        </li>
      </ul>
    </nav>
  </header>
  <!-- FIN HEADER -->

  <main>
    <div class="wrap">
      <a class="back-btn" href="adminProducts.html">← Volver al listado</a>

      <div class="card-form">
        <h1>Actualizar producto</h1>
        <p class="subtitle">Modificá los datos y cargá una nueva imagen si querés</p>

        <form id="updateForm" enctype="multipart/form-data">
          <div class="field" style="grid-column:1 / -1;">
            <label for="name">Nombre del producto *</label>
            <input type="text" id="name" name="name" required/>
          </div>

          <div class="field">
            <label for="price">Precio *</label>
            <input type="number" id="price" name="price" step="0.01" min="0" required/>
          </div>

          <div class="field">
            <label for="stock">Stock *</label>
            <input type="number" id="stock" name="stock" min="0" required/>
          </div>

          <div class="field">
            <label for="color">Color</label>
            <input type="text" id="color" name="color"/>
          </div>

          <div class="field">
            <label for="material">Material</label>
            <input type="text" id="material" name="material"/>
          </div>

          <div class="field">
            <label for="waist">Talle</label>
            <input type="text" id="waist" name="waist"/>
          </div>

          <div class="field">
            <label for="categoriaSelect">Categoría *</label>
            <select id="categoriaSelect" name="idCategory" required></select>
          </div>

          <div class="field" style="grid-column:1 / -1;">
            <label for="file">Imagen</label>
            <input type="file" id="file" name="file" accept="image/*"/>
          </div>

          <img id="previewImage" alt="Imagen actual"/>

          <div class="actions">
            <button id="submitBtn" type="submit">Actualizar Producto</button>
          </div>
          <div id="message"></div>
        </form>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const API = "http://localhost:8080";
      const token = localStorage.getItem("jwtToken");
      if(!token) { window.location.replace("login.html"); return; }

      const form = document.getElementById("updateForm");
      const msg = document.getElementById("message");
      const preview = document.getElementById("previewImage");
      const fileInput = document.getElementById("file");
      const selectCat = document.getElementById("categoriaSelect");
      const submitBtn = document.getElementById("submitBtn");

      function showMessage(text,type="success"){
        msg.textContent=text;
        msg.className=type;
      }

      // Cargar categorías
      async function cargarCategorias(){
        const res=await fetch(API+"/category/get",{headers:{Authorization:"Bearer "+token}});
        const cats=await res.json();
        selectCat.innerHTML="";
        cats.forEach(c=>{
          const opt=document.createElement("option");
          opt.value=c.idCategory; opt.textContent=c.name;
          selectCat.appendChild(opt);
        });
      }
      await cargarCategorias();

      // Tomar producto desde la URL
      const urlParams = new URLSearchParams(window.location.search);
      const productName = urlParams.get("name");

      if(productName){
        const res=await fetch(`${API}/products/getName/${encodeURIComponent(productName)}`,{
          headers:{Authorization:"Bearer "+token}
        });
        if(res.ok){
          const p=await res.json();
          document.getElementById("name").value=p.name;
          document.getElementById("price").value=p.price;
          document.getElementById("stock").value=p.stock;
          document.getElementById("color").value=p.color||"";
          document.getElementById("material").value=p.material||"";
          document.getElementById("waist").value=p.waist||"";
          if(p.categoryId) selectCat.value=p.categoryId;
          if(p.imageUrl){ preview.src=API+p.imageUrl; preview.style.display="block"; }
        } else {
          showMessage("No se pudo cargar el producto","error");
        }
      }

      // Previsualización nueva imagen
      fileInput.addEventListener("change",()=>{
        const f=fileInput.files[0];
        if(f){
          const reader=new FileReader();
          reader.onload=e=>{ preview.src=e.target.result; preview.style.display="block"; };
          reader.readAsDataURL(f);
        }
      });

      // Enviar actualización
      form.addEventListener("submit",async e=>{
        e.preventDefault();
        submitBtn.disabled=true;

        const fd=new FormData(form);
        try{
          const res=await fetch(`${API}/products/update/${encodeURIComponent(productName)}`,{
            method:"PUT",
            headers:{Authorization:"Bearer "+token},
            body:fd
          });
          if(res.ok){
            showMessage("Producto actualizado con éxito!");
            setTimeout(()=>window.location.href="adminProducts.html",1500);
          } else {
            const t=await res.text();
            showMessage(t,"error");
          }
        }catch(err){
          showMessage("Error al actualizar","error");
        }finally{
          submitBtn.disabled=false;
        }
      });
    });
  </script>
</body>
</html>
