<!DOCTYPE html>
<html lang="es">
<head>
  <script src="../js/checkJwt.js" defer></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Detalles de Órdenes de Productos</title>

  <!-- Header unificado dependencies -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="../css/normalize.css"/>
  <link rel="stylesheet" href="../css/style.css"/>

  <style>
    :root{
      --bg:#fff0f5;
      --card:#ffffff;
      --text:#442a38;
      --muted:#6b7280;
      --brand1:#ec4899;
      --brand2:#db2777;
      --ring:rgba(0,0,0,.06);
      --border:#f7e1ef;
      --row:#fff5fa;
      --row-alt:#ffe9f2;
      --row-hover:rgba(236,72,153,.12);
      --radius:14px;
    }

    body{
      margin:0; background:var(--bg); color:var(--text);
      min-height:100dvh; display:flex; flex-direction:column;
      font-family:'Segoe UI', Tahoma, sans-serif;
    }

    .page-wrap{
      width:100%; max-width:1100px;
      margin: clamp(24px,6vw,64px) auto 40px;
      padding: 0 20px;
    }

    /* Back button (gris, secundario) */
    .btn-volver{
      background:#e5e7eb; color:#374151;
      padding:10px 16px; border-radius:10px;
      text-decoration:none; font-weight:700;
      display:inline-flex; align-items:center; gap:8px;
      transition: background .2s ease, transform .15s ease;
    }
    .btn-volver:hover{ background:#d1d5db; transform: translateY(-1px); }

    /* Card */
    .card-orders{
      background:var(--card); border-radius:var(--radius);
      box-shadow: 0 10px 30px var(--ring);
      border:1px solid var(--border); overflow:hidden;
    }
    .card-head{
      padding:18px 20px; display:flex; align-items:center; gap:12px; border-bottom:1px solid #f1f5f9;
    }
    .badge{
      width:42px; height:42px; border-radius:12px; color:#fff;
      background: linear-gradient(90deg, var(--brand1), var(--brand2));
      display:grid; place-items:center; font-size:1.1rem;
      box-shadow: 0 6px 16px rgba(236,72,153,.25);
    }
    .card-head h1{
      margin:0; font-size: clamp(1.2rem, 3vw, 1.6rem);
      background: linear-gradient(90deg, var(--brand1), var(--brand2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .card-head p{ margin:2px 0 0; color:var(--muted); }

    .card-body{ padding:14px 20px 22px; }

    /* Toolbar filtro */
    .toolbar{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      margin: 6px 0 14px;
    }
    .searchbox{
      display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; background:#fff;
      border:1px solid var(--border); box-shadow:0 1px 2px var(--ring);
      min-width:280px;
    }
    .searchbox i{ color:var(--brand2); }
    .searchbox input{
      border:0; outline:0; background:transparent; font-size:1rem; width:260px; max-width:60vw;
    }
    .searchbox:focus-within{ box-shadow:0 0 0 4px rgba(236,72,153,.15); border-color:#f6c3e1; }

    .meta{
      background:#fff; color:var(--muted);
      border:1px solid var(--border); border-radius:999px;
      padding:8px 12px; box-shadow:0 1px 2px var(--ring);
      font-size:.95rem;
    }

    /* Tabla */
    table{ width:100%; border-collapse:collapse; background:#fff; }
    thead th{
      background: linear-gradient(90deg, var(--brand1), var(--brand2));
      color:#fff; text-align:center; padding:12px;
      position:sticky; top:0; z-index:1; border-bottom:none; font-size:.9rem;
    }
    tbody td{ padding:12px; text-align:center; border-bottom:1px solid #eef2f7; font-size:.95rem; }
    tbody tr:nth-child(odd){ background:var(--row); }
    tbody tr:nth-child(even){ background:var(--row-alt); }
    tbody tr:hover{ background:var(--row-hover); }
    td strong{ color:var(--brand1); }

    .loader{
      display:none; text-align:center; margin: 6px 0 16px; color:var(--brand2); font-weight:700;
    }

    @media (max-width:700px){
      .card-body{ padding:12px 12px 18px; }
      thead th, tbody td{ padding:10px; }
      .searchbox input{ width: 180px; }
    }
  </style>
</head>
<body>


  <!-- CONTENIDO -->
  <div class="page-wrap">
    <a href="admin.html" class="btn-volver"><i class="fa-solid fa-arrow-left"></i> Volver al panel</a>

    <div class="card-orders" role="region" aria-labelledby="title-orders">
      <div class="card-head">
        <div class="badge"><i class="fa-solid fa-receipt"></i></div>
        <div>
          <h1 id="title-orders">Detalles de Órdenes de Productos</h1>
          <p>Visualización de líneas de orden: cliente, producto, precios y totales.</p>
        </div>
      </div>

      <div class="card-body">
        <div class="toolbar">
          <label class="searchbox" for="q">
            <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
            <input id="q" type="text" placeholder="Buscar por cliente, producto o ID…" aria-label="Buscar en órdenes">
          </label>
          <div id="meta" class="meta">—</div>
        </div>

        <div class="loader" id="loader">Cargando datos…</div>

        <table id="orderTable">
          <thead>
            <tr>
              <th>ID Cliente</th>
              <th>Cliente</th>
              <th>ID Producto</th>
              <th>Producto</th>
              <th>ID Orden</th>
              <th>Precio Unitario</th>
              <th>Cantidad</th>
              <th>Descuento</th>
              <th>Precio Final</th>
            </tr>
          </thead>
          <tbody><!-- dinámico --></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- JS: submenús por click en mobile -->
  <script>
    (function () {
      const mq = window.matchMedia('(max-width: 900px)');
      document.addEventListener('click', (e) => {
        const trigger = e.target.closest('.submenu > a'); if (!trigger) return;
        if (mq.matches) {
          e.preventDefault();
          const li = trigger.parentElement;
          document.querySelectorAll('.submenu.open').forEach(x => { if (x !== li) x.classList.remove('open'); });
          li.classList.toggle('open');
        }
      });
      document.addEventListener('click', (e) => {
        const trigger = e.target.closest('.submenu-has-children > a'); if (!trigger) return;
        if (mq.matches) {
          e.preventDefault();
          const li = trigger.parentElement;
          li.classList.toggle('open');
          const panel = li.querySelector('.subsubmenu-items');
          if (panel) panel.style.display = (panel.style.display === 'block' ? 'none' : 'block');
        }
      });
    })();
  </script>

  <!-- JS: carga + filtro -->
  <script>
    const $ = (q)=>document.querySelector(q);
    const tbody = $('#orderTable tbody');
    const loader = $('#loader');
    const meta = $('#meta');
    const q = $('#q');

    const money = new Intl.NumberFormat('es-AR', { style:'currency', currency:'ARS', minimumFractionDigits:2 });

    let allRows = [];
    let filtered = [];

    function rowHTML(item){
      const unit = Number(item.unitPrice||0);
      const qty  = Number(item.quantity||0);
      const disc = Number(item.discount||0);
      const final = ('priceFinal' in item) ? Number(item.priceFinal||0) : (unit*qty - disc);
      return `
        <tr>
          <td>${item.idClient ?? '-'}</td>
          <td>${item.clientName ?? '-'}</td>
          <td>${item.idProduct ?? '-'}</td>
          <td>${item.productName ?? '-'}</td>
          <td>${item.idOrder ?? '-'}</td>
          <td>${money.format(unit)}</td>
          <td>${qty}</td>
          <td>${money.format(disc)}</td>
          <td><strong>${money.format(final)}</strong></td>
        </tr>
      `;
    }

    function render(list){
      if(!Array.isArray(list) || list.length === 0){
        tbody.innerHTML = `<tr><td colspan="9">No hay datos disponibles</td></tr>`;
        return;
      }
      tbody.innerHTML = list.map(rowHTML).join('');
    }

    function applyFilter(){
      const s = q.value.trim().toLowerCase();
      if(!s){
        filtered = allRows.slice();
      }else{
        filtered = allRows.filter(it =>
          String(it.idClient ?? '').includes(s) ||
          String(it.idProduct ?? '').includes(s) ||
          String(it.idOrder ?? '').includes(s) ||
          (it.clientName ?? '').toLowerCase().includes(s) ||
          (it.productName ?? '').toLowerCase().includes(s)
        );
      }
      render(filtered);
      meta.textContent = `${filtered.length} resultado(s) • total ${allRows.length}`;
    }

    function debounce(fn, ms=220){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
    }

    document.addEventListener("DOMContentLoaded", async () => {
      loader.style.display = "block";
      try{
        const res = await fetch("http://localhost:8080/orderDetail");
        if(!res.ok) throw new Error("Error en la petición");
        const data = await res.json();

        loader.style.display = "none";
        allRows = Array.isArray(data) ? data : [];
        applyFilter();
      }catch(err){
        loader.style.display = "none";
        tbody.innerHTML = `<tr><td colspan="9">Error cargando los datos</td></tr>`;
        meta.textContent = "—";
        console.error(err);
      }
    });

    q.addEventListener('input', debounce(applyFilter, 180));
  </script>

  <!-- (Opcional) Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
</body>
</html>
