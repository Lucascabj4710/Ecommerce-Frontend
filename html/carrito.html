<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Carrito de Compras</title>

  <!-- Requisitos del header (igual que en el resto del sitio) -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../css/normalize.css" />
  <link rel="stylesheet" href="../css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
  /* 1. Paleta de Colores y Variables Globales */
  :root{
      --bg-light: #fef0f8;
      --card-bg: #ffffff;
      --text-dark: #3a1c2a;
      --text-muted: #8c607a;
      --brand-primary: #e84a96;
      --brand-secondary: #f062a4;
      --brand-dark: #d63a81;
      --border-light: #fcdde9;
      --focus-ring: rgba(232, 74, 150, 0.3);
      --shadow-light: rgba(232, 74, 150, 0.08);
      --shadow-medium: rgba(232, 74, 150, 0.15);
      --danger-color: #ef4444;
      --danger-dark: #dc2626;
      --radius-default: 14px;
      --radius-large: 20px;
      --transition-ease: all 0.25s ease-out;
  }

  *{box-sizing:border-box}
  body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-light);
      color: var(--text-dark);
      margin:0;
      padding: 0 0 120px; /* solo espacio inferior para la summary bar */
  }

  /* 3. Contenido Principal */
  .page-header{
      padding: 24px 20px 0;
      text-align:center;
  }
  h1{
      margin:0 auto 20px;
      max-width:980px;
      font-size: 2rem;
      font-weight:800;
      background: linear-gradient(90deg, var(--brand-primary), var(--brand-secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
  }

  .container{
      max-width:980px;
      margin:0 auto;
      padding:0 20px 24px;
  }
  .cart{
      background: var(--card-bg);
      border-radius: var(--radius-large);
      box-shadow: 0 10px 30px var(--shadow-light);
      overflow:hidden;
  }

  /* 4. √çtems del Carrito */
  .item{
      display:flex; gap:20px; padding:20px;
      border-bottom:1px solid var(--border-light);
      align-items:center; position:relative;
      transition: background var(--transition-ease);
  }
  .item:hover{ background: var(--bg-light); }
  .item:last-child{ border-bottom:none; }

  .thumb{
      width:100px; height:100px; flex:0 0 100px;
      border-radius: var(--radius-default);
      overflow:hidden; border:1px solid var(--border-light);
      background:#fff;
  }
  .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }

  .info{ flex:1 1 auto; min-width:0; }
  .title{
      margin:0 0 6px; font-size:1.1rem; font-weight:700; color:var(--text-dark);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .meta{
      margin:0; color:var(--text-muted); font-size:0.9rem; line-height:1.5;
      display:flex; gap:16px; flex-wrap:wrap;
  }

  .right{ text-align:right; min-width:160px; }
  .price{
      margin:0; font-weight:700; font-size:1.1rem;
      color: var(--brand-primary);
  }
  .qty{ margin:6px 0 0; font-size:0.9rem; color:var(--text-muted); }

  .delete-btn{
      position:absolute; right:18px; top:18px;
      width:36px; height:36px; border-radius:50%;
      border:none; background:var(--danger-color); color:#fff;
      font-weight:700; font-size: 1.2rem; cursor:pointer;
      display:grid; place-items:center; opacity: 0;
      transform: scale(0.8);
      transition: var(--transition-ease);
      box-shadow:0 6px 14px rgba(239,68,68,.3);
  }
  .item:hover .delete-btn { opacity: 1; transform: scale(1); }
  .delete-btn:hover{ background:var(--danger-dark); transform: scale(1.1); }

  /* 5. Barra de Resumen (Footer Fijo) */
  .summary-bar{
      position: fixed; left:0; right:0; bottom:0;
      background: linear-gradient(90deg, #4a2c41, #3a1c2a);
      color:#fff;
      padding:16px 20px;
      box-shadow:0 -8px 24px rgba(0,0,0,.18);
      z-index:100;
  }
  .summary-inner{
      max-width:980px; margin:0 auto;
      display:flex; align-items:center; gap:16px;
  }
  .total-chip{
      margin-left:auto;
      background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
      padding:10px 18px; border-radius:999px;
      display:flex; align-items:baseline; gap:10px;
      box-shadow:0 8px 20px rgba(232, 74, 150, 0.35);
  }
  .total-chip .label{
      font-size:12px; letter-spacing:1px;
      text-transform:uppercase; opacity:.9; font-weight: 600;
  }
  .total-chip .value{
      font-weight:800; font-size:22px; line-height:1;
      text-shadow:0 2px 6px rgba(0,0,0,.25);
  }

  .checkout-btn{
      background: var(--card-bg);
      color: var(--text-dark);
      border:none; font-weight:700; padding:12px 20px;
      border-radius:10px; cursor:pointer;
      transition: var(--transition-ease);
  }
  .checkout-btn:hover{
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(255,255,255,.15);
      background:#ffe4f0;
  }
  .checkout-btn:disabled { opacity: 0.7; cursor: wait; }

  /* 6. Otros Estilos (Empty State, Animaciones, Modal, Toast) */
  .empty{ padding:60px; text-align:center; color:var(--text-muted); font-size: 1.1rem; }
  .fade-out{ animation: fadeUp .4s ease-out forwards; }
  @keyframes fadeUp{ to{ opacity:0; transform: translateY(-10px); max-height:0; margin:0; padding:0; border:0; } }

  .modal-overlay {
      position: fixed; inset: 0; z-index: 2000;
      background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
      display: flex; align-items: center; justify-content: center;
      opacity: 0; visibility: hidden; transition: var(--transition-ease);
  }
  .modal-overlay.show { opacity: 1; visibility: visible; }
  .modal-content {
      background: var(--card-bg); border-radius: var(--radius-large);
      padding: 30px; width: 90%; max-width: 400px;
      text-align: center; transform: scale(0.9);
      transition: var(--transition-ease);
  }
  .modal-overlay.show .modal-content { transform: scale(1); }
  #modal-title { font-size: 1.4rem; margin-bottom: 10px; color: var(--text-dark); }
  #modal-message { margin-bottom: 25px; color: var(--text-muted); line-height: 1.6; }
  .modal-actions { display: flex; gap: 15px; }
  .modal-actions button {
      flex: 1; padding: 12px; border: none; border-radius: 10px;
      font-weight: 700; cursor: pointer; transition: var(--transition-ease);
  }
  #modal-confirm-btn { background: var(--brand-primary); color: #fff; }
  #modal-confirm-btn:hover { background: var(--brand-dark); }
  #modal-cancel-btn { background: #e2e8f0; color: var(--text-dark); }
  #modal-cancel-btn:hover { background: #cbd5e1; }

  .toast {
      position: fixed; bottom: 25px; right: 25px; padding: 15px 25px;
      border-radius: var(--radius-default); color: #fff; font-weight: 600;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2); opacity: 0; visibility: hidden;
      transform: translateY(20px); transition: all 0.4s ease; z-index: 2000;
      background-color: var(--danger-color);
  }
  .toast.show { opacity: 1; visibility: visible; transform: translateY(0); }
  </style>
</head>
<body>


  <!-- CONTENIDO -->
  <main class="container">
    <div class="page-header">
      <h1>üõí Mi Carrito</h1>
    </div>
    <section id="cart" class="cart"></section>
    <div id="emptyState" class="cart" style="display:none;">
      <p class="empty">Tu carrito est√° vac√≠o.</p>
    </div>
  </main>

  <aside class="summary-bar">
    <div class="summary-inner">
      <button id="checkoutBtn" class="checkout-btn" type="button">Finalizar compra</button>
      <div class="total-chip" aria-live="polite" aria-atomic="true">
        <span class="label">Total</span>
        <span id="totalValue" class="value">$ 0,00</span>
      </div>
    </div>
  </aside>

  <div id="custom-modal-overlay" class="modal-overlay">
    <div class="modal-content">
      <h3 id="modal-title"></h3>
      <p id="modal-message"></p>
      <div class="modal-actions">
        <button id="modal-cancel-btn">Cancelar</button>
        <button id="modal-confirm-btn">Confirmar</button>
      </div>
    </div>
  </div>
  <div id="toast-notification" class="toast"></div>

  <!-- JS: dropdown m√≥vil por click (usa tus clases .submenu/.submenu-items) -->
  <script>
    (function () {
      const mq = window.matchMedia('(max-width: 900px)');

      // Nivel 1 (Productos / Cuenta)
      document.addEventListener('click', (e) => {
        const trigger = e.target.closest('.submenu > a');
        if (!trigger) return;

        if (mq.matches) {
          e.preventDefault();
          const li = trigger.parentElement;        // <li class="submenu">
          document.querySelectorAll('.submenu.open').forEach(x => { if (x !== li) x.classList.remove('open'); });
          li.classList.toggle('open');
        }
      });

      // Nivel 2 (Anillos / Pulseras / Collares)
      document.addEventListener('click', (e) => {
        const trigger = e.target.closest('.submenu-has-children > a');
        if (!trigger) return;

        if (mq.matches) {
          e.preventDefault();
          const li = trigger.parentElement; // <li class="submenu-has-children">
          li.classList.toggle('open');
          const panel = li.querySelector('.subsubmenu-items');
          if (panel) panel.style.display = (panel.style.display === 'block' ? 'none' : 'block');
        }
      });
    })();
  </script>

  <!-- L√ìGICA DEL CARRITO -->
  <script>
  // --- Funciones de UI Mejoradas (Modal y Toast) ---
  const modalOverlay = document.getElementById('custom-modal-overlay');
  const modalTitle = document.getElementById('modal-title');
  const modalMessage = document.getElementById('modal-message');
  const modalConfirmBtn = document.getElementById('modal-confirm-btn');
  const modalCancelBtn = document.getElementById('modal-cancel-btn');
  const toastEl = document.getElementById('toast-notification');

  function showToast(message) {
      toastEl.textContent = message;
      toastEl.classList.add('show');
      setTimeout(() => toastEl.classList.remove('show'), 3000);
  }

  function showModal({ title, message, showCancel = true, confirmText = 'Confirmar', cancelText = 'Cancelar' }) {
      return new Promise(resolve => {
          modalTitle.textContent = title;
          modalMessage.textContent = message;
          modalConfirmBtn.textContent = confirmText;
          modalCancelBtn.textContent = cancelText;

          modalCancelBtn.style.display = showCancel ? 'block' : 'none';
          if (!showCancel) { modalConfirmBtn.textContent = 'Aceptar'; }

          modalOverlay.classList.add('show');

          const onConfirm = () => { modalOverlay.classList.remove('show'); resolve(true); cleanup(); };
          const onCancel  = () => { modalOverlay.classList.remove('show'); resolve(false); cleanup(); };
          const cleanup = () => {
            modalConfirmBtn.removeEventListener('click', onConfirm);
            modalCancelBtn.removeEventListener('click', onCancel);
          };

          modalConfirmBtn.addEventListener('click', onConfirm);
          modalCancelBtn.addEventListener('click', onCancel);
      });
  }

  // --- L√≥gica del Carrito ---
  const CURRENCY = new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',minimumFractionDigits:2});
  const cartEl = document.getElementById('cart');
  const emptyEl = document.getElementById('emptyState');
  const totalEl = document.getElementById('totalValue');
  const checkoutBtn = document.getElementById('checkoutBtn');

  let currentTotal = 0;
  let cartDetailsGlobal = [];
  let currentCartId = null;

  function animateTotal(from, to, duration = 600) {
      const start = performance.now();
      function frame(now){
          const t = Math.min(1, (now - start) / duration);
          const eased = t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
          const val = from + (to - from) * eased;
          totalEl.textContent = CURRENCY.format(val);
          if (t < 1) requestAnimationFrame(frame);
          else currentTotal = to;
      }
      requestAnimationFrame(frame);
  }

  async function fetchWithToken(url, options = {}) {
      const token = localStorage.getItem("jwtToken");
      options.headers = { ...options.headers, "Authorization": token ? `Bearer ${token}` : "", "Content-Type": "application/json" };
      const res = await fetch(url, options);
      if (res.status === 401) {
          localStorage.removeItem("jwtToken");
          showToast("Sesi√≥n expirada. Por favor, inicia sesi√≥n de nuevo.");
          setTimeout(() => window.location.href = "login.html", 2000);
          throw new Error("Sesi√≥n expirada");
      }
      return res;
  }

  async function fetchCartId() {
      try {
          const res = await fetchWithToken("http://localhost:8080/cart/getCartID");
          if (!res.ok) throw new Error("Respuesta no v√°lida del servidor");
          currentCartId = await res.json();
      } catch (err) {
          console.error("No se pudo obtener el ID del carrito:", err);
      }
  }

  async function loadCart() {
      await fetchCartId();
      if (!currentCartId) { emptyEl.style.display = 'block'; cartEl.style.display = 'none'; return; }

      try {
          const res = await fetchWithToken("http://localhost:8080/cartDetail/get");
          const data = await res.json();

          if (!data || data.length === 0) {
              emptyEl.style.display = 'block';
              cartEl.style.display = 'none';
              animateTotal(currentTotal, 0);
              return;
          }

          cartDetailsGlobal = data.map(cd => ({ ...cd }));
          cartEl.innerHTML = "";
          emptyEl.style.display = 'none';
          cartEl.style.display = 'block';
          let total = 0;

          data.forEach(cd => {
              const p = cd.productResponseDto || {};
              const imageFullUrl = p.imageUrl ? ('http://localhost:8080' + p.imageUrl) : 'https://via.placeholder.com/120';
              const item = document.createElement('div');
              item.className = 'item';
              item.dataset.productName = p.name;
              item.innerHTML = `
                  <div class="thumb"><img src="${imageFullUrl}" alt="${p.name || 'Producto'}"></div>
                  <div class="info">
                      <h3 class="title" title="${p.name || ''}">${p.name || 'Sin nombre'}</h3>
                      <p class="meta">
                          <span>${p.categoryDesc || 'Sin categor√≠a'}</span>
                          ${p.color ? `<span>Color: ${p.color}</span>` : ''}
                          ${p.material ? `<span>Material: ${p.material}</span>` : ''}
                          ${p.waist ? `<span>Talle: ${p.waist}</span>` : ''}
                      </p>
                  </div>
                  <div class="right">
                      <p class="price">${CURRENCY.format(cd.unitPrice ?? p.price ?? 0)}</p>
                      <p class="qty">Cantidad: ${cd.quantity ?? 1}</p>
                  </div>
                  <button class="delete-btn" title="Eliminar" aria-label="Eliminar">√ó</button>
              `;
              cartEl.appendChild(item);
              total += (cd.unitPrice ?? p.price ?? 0) * (cd.quantity ?? 1);
          });

          animateTotal(currentTotal, total);

      } catch (err) {
          console.error("Error cargando carrito:", err);
          emptyEl.style.display = 'block';
          cartEl.style.display = 'none';
          animateTotal(currentTotal, 0);
      }
  }

  cartEl.addEventListener('click', async (e) => {
      if (!e.target.classList.contains('delete-btn')) return;

      const itemDiv = e.target.closest('.item');
      const productName = itemDiv?.dataset?.productName;
      if (!currentCartId || !productName) {
          showModal({ title: 'Error', message: 'No se pudo identificar el producto.', showCancel: false });
          return;
      }

      const confirmed = await showModal({
          title: 'Confirmar',
          message: `¬øSeguro que quer√©s eliminar "${productName}" del carrito?`
      });
      if (!confirmed) return;

      try {
          const res = await fetchWithToken(
              `http://localhost:8080/cartDetail/delete/${currentCartId}/${encodeURIComponent(productName)}`, 
              { method: 'DELETE' }
          );
          const result = await res.text(); // backend devuelve string

          if (result === "Operaci√≥n realizada con √©xito") {
              itemDiv.classList.add('fade-out');
              itemDiv.addEventListener('animationend', () => {
                  itemDiv.remove();
                  recalcTotalFromDOM();
                  if (!cartEl.querySelector('.item')) {
                      emptyEl.style.display = 'block';
                      cartEl.style.display = 'none';
                  }
                  cartDetailsGlobal = cartDetailsGlobal.filter(cd => cd.productResponseDto.name !== productName);
              }, { once: true });
          } else {
              showModal({ title: 'Error', message: 'No se pudo eliminar el producto.', showCancel: false });
          }
      } catch (err) {
          console.error('Error eliminando producto:', err);
          showModal({ title: 'Error', message: 'Hubo un problema al eliminar el producto.', showCancel: false });
      }
  });

  function recalcTotalFromDOM() {
      let newTotal = 0;
      const items = cartEl.querySelectorAll('.item');
      items.forEach(it => {
          const priceText = it.querySelector('.price')?.textContent || '$ 0,00';
          const qtyText = it.querySelector('.qty')?.textContent || 'Cantidad: 1';
          const price = parseFloat(priceText.replace(/[^\d,.-]/g, '').replace('.', '').replace(',', '.'));
          const qty = parseInt(qtyText.replace(/[^\d]/g, ''), 10) || 1;
          newTotal += (isNaN(price) ? 0 : price) * qty;
      });
      animateTotal(currentTotal, newTotal);
  }

checkoutBtn.addEventListener('click', async () => {
    if (cartDetailsGlobal.length === 0) {
        showModal({
            title: 'Carrito Vac√≠o',
            message: 'No tienes productos en el carrito para comprar.',
            showCancel: false
        });
        return;
    }

    if (!currentCartId) {
        showModal({
            title: 'Error',
            message: 'No se pudo identificar tu carrito.',
            showCancel: false
        });
        return;
    }

    checkoutBtn.disabled = true;
    checkoutBtn.textContent = 'Procesando‚Ä¶';

    try {
        // üîπ Armo la lista de productos a enviar
        const orderDtos = cartDetailsGlobal.map(cd => ({
            productName: cd.productResponseDto.name,
            quantity: cd.quantity ?? 1,
            discount: 0
        }));

        // üîπ Env√≠o una sola request con la lista
        await fetchWithToken('http://localhost:8080/orderDetail/create', {
            method: 'POST',
            body: JSON.stringify(orderDtos)
        });

        // üîπ Despu√©s elimino los productos del carrito
        const deletePromises = cartDetailsGlobal.map(cd =>
            fetchWithToken(
                `http://localhost:8080/cartDetail/delete/${currentCartId}/${encodeURIComponent(cd.productResponseDto.name)}`,
                { method: 'DELETE' }
            )
        );
        await Promise.all(deletePromises);

        // üîπ Mensaje de √©xito
        await showModal({
            title: '¬°Compra Exitosa!',
            message: 'Tu pedido ha sido procesado correctamente. ¬°Gracias por tu compra!',
            showCancel: false
        });

        // üîπ Limpio el carrito en frontend
        cartDetailsGlobal = [];
        cartEl.innerHTML = '';
        animateTotal(currentTotal, 0);
        emptyEl.style.display = 'block';
        cartEl.style.display = 'none';

    } catch (err) {
        console.error('Error creando ordenes:', err);
        showModal({
            title: 'Error en la Compra',
            message: 'Hubo un problema al procesar tu pedido. Por favor, intenta de nuevo.',
            showCancel: false
        });
    } finally {
        checkoutBtn.disabled = false;
        checkoutBtn.textContent = 'Finalizar compra';
    }
});


  loadCart();
  </script>

  <!-- (Opcional) Popper y Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
</body>
</html>
